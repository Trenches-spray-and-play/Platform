"use client";

import { useEffect, useState } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import styles from './dashboard.module.css';
import { useAuth } from '@/components/AuthProvider';
import ReviewPool from '@/components/ReviewPool';
import SubmitContentModal from '@/components/SubmitContentModal';
import ReviewModal from '@/components/ReviewModal';
import PointsWidget from '@/components/PointsWidget';
import TaskList from '@/components/TaskList';
import Logo from '@/components/Logo';

interface Position {
    id: string;
    trenchId: string;
    trenchName: string;
    trenchLevel: string;
    status: string;
    joinedAt: string;
    boostPoints: number;
    entryAmount: number;
    maxPayout: number;
    receivedAmount: number;
    queuePosition: number;
    expiresAt: string | null;
}

interface ReviewPost {
    id: string;
    platform: string;
    url: string;
    contentType: string;
    endorsements: number;
    user: {
        id: string;
        handle: string;
        beliefScore: number;
    };
}

interface UserProfile {
    id: string;
    beliefScore: number;
    boostPoints: number;
}

interface Task {
    id: string;
    title: string;
    description: string | null;
    reward: number;
    link: string | null;
    status: 'pending' | 'completed';
}

export default function DashboardPage() {
    const router = useRouter();
    const { user, isLoading: authLoading } = useAuth();
    const [positions, setPositions] = useState<Position[]>([]);
    const [profile, setProfile] = useState<UserProfile | null>(null);
    const [tasks, setTasks] = useState<Task[]>([]);
    const [completedTaskIds, setCompletedTaskIds] = useState<Set<string>>(new Set());
    const [loading, setLoading] = useState(true);

    // Social system modals
    const [isSubmitOpen, setIsSubmitOpen] = useState(false);
    const [isReviewOpen, setIsReviewOpen] = useState(false);
    const [selectedPost, setSelectedPost] = useState<ReviewPost | null>(null);
    const [refreshKey, setRefreshKey] = useState(0);

    useEffect(() => {
        if (!authLoading && user) {
            fetchData();
        } else if (!authLoading && !user) {
            setLoading(false);
        }
    }, [authLoading, user]);

    const fetchData = async () => {
        try {
            const [positionsRes, profileRes, tasksRes, completedRes] = await Promise.all([
                fetch('/api/user/positions'),
                fetch('/api/user'),
                fetch('/api/tasks'),
                fetch('/api/user/tasks'),
            ]);

            const positionsData = await positionsRes.json();
            const profileData = await profileRes.json();
            const tasksData = await tasksRes.json();
            const completedData = await completedRes.json();

            if (positionsData.data) {
                setPositions(positionsData.data);
            }
            if (profileData.data) {
                setProfile(profileData.data);
            }

            // Merge tasks with completion status
            const completedIds = new Set<string>(
                (completedData.data || []).map((t: { taskId: string }) => t.taskId)
            );
            setCompletedTaskIds(completedIds);

            const mergedTasks = (tasksData.data || []).map((task: Task) => ({
                ...task,
                status: completedIds.has(task.id) ? 'completed' : 'pending',
            }));
            setTasks(mergedTasks);
        } catch (error) {
            console.error('Failed to fetch dashboard data:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleReview = (post: ReviewPost) => {
        setSelectedPost(post);
        setIsReviewOpen(true);
    };

    const handleReviewSuccess = () => {
        setRefreshKey(prev => prev + 1);
    };

    const handleSubmitSuccess = () => {
        setRefreshKey(prev => prev + 1);
    };

    const handleTaskComplete = async (reward: number, taskId?: string) => {
        if (!taskId) return;
        try {
            const res = await fetch('/api/user/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ taskId }),
            });
            const data = await res.json();

            if (data.success) {
                setCompletedTaskIds(prev => new Set([...prev, taskId]));
                setTasks(prev => prev.map(t =>
                    t.id === taskId ? { ...t, status: 'completed' as const } : t
                ));
                // Refresh profile to get updated boost points
                const profileRes = await fetch('/api/user');
                const profileData = await profileRes.json();
                if (profileData.data) setProfile(profileData.data);
            }
        } catch (error) {
            console.error('Failed to complete task:', error);
        }
    };

    if (authLoading) {
        return <div className={styles.loading}>LOADING COMMAND...</div>;
    }

    // Show unauthenticated state
    if (!user) {
        return (
            <main className={styles.container}>
                <header className={styles.header}>
                    <div className="desktop-hidden">
                        <Logo variant="horizontal" />
                    </div>
                    <div className="status-indicator offline">OFFLINE</div>
                </header>

                <div className={styles.vaultContainer}>
                    <div className={styles.vaultOverlay} />
                    <div className={styles.vaultIcon}>
                        <Logo variant="icon" width={100} color="#d4af37" />
                    </div>
                    <h1 className={styles.vaultTitle}>DASHBOARD</h1>
                    <p className={styles.vaultSubtitle}>
                        Identity verification lost. Re-sync protocol to restore deployment visibility.
                    </p>
                    <Link href="/login" className="premium-button">LOGIN</Link>
                </div>
            </main>
        );
    }

    if (loading) {
        return <div className={styles.loading}>LOADING COMMAND...</div>;
    }

    return (
        <main className={styles.container}>
            <header className={styles.header}>
                <div className="desktop-hidden">
                    <Logo variant="horizontal" />
                </div>
                <div className="status-indicator">ONLINE</div>
            </header>

            <div className={styles.contentGrid}>
                <div className={styles.scrollArea}>
                    {/* Positions Section */}
                    {positions.length === 0 ? (
                        <div className={styles.emptyState}>
                            <p>NO DEPLOYMENTS</p>
                            <Link href="/" className={styles.sprayBtn}>INITIATE SPRAY</Link>
                        </div>
                    ) : (
                        <section className={`${styles.positionsSection} animate-fade-in`}>
                            <h2 className="label-s" style={{ marginBottom: '2rem' }}>ACTIVE_DEPLOYMENTS</h2>
                            <div className={styles.positionsGrid}>
                                {positions.map((pos, idx) => (
                                    <div key={pos.id} className={`${styles.positionCard} ${styles[pos.trenchLevel.toLowerCase()]} animate-fade-in`} style={{ animationDelay: `${idx * 0.1}s` }}>
                                        <div className={styles.positionHeader}>
                                            <span className={`${styles.trenchLevel} ${styles['level_' + pos.trenchLevel.toLowerCase()]}`}>
                                                {pos.trenchLevel} TRENCH
                                            </span>
                                            <span className="label-s" style={{ color: 'var(--text-muted)' }}>{pos.status.toUpperCase()}</span>
                                        </div>
                                        <div className={styles.positionStats}>
                                            <div className={styles.stat} style={{ borderBottom: '1px solid rgba(255,255,255,0.02)', paddingBottom: '0.75rem' }}>
                                                <span className={styles.statLabel}>QUEUE</span>
                                                <span className={styles.statValue}>#{pos.queuePosition}</span>
                                            </div>
                                            <div className={styles.stat} style={{ borderBottom: '1px solid rgba(255,255,255,0.02)', paddingBottom: '0.75rem' }}>
                                                <span className={styles.statLabel}>ROI</span>
                                                <span className={styles.statValue} style={{ color: 'var(--accent-rapid)' }}>{pos.maxPayout / pos.entryAmount}X</span>
                                            </div>
                                            <div className={styles.stat}>
                                                <span className={styles.statLabel}>ENTRY</span>
                                                <span className={styles.statValue}>${pos.entryAmount}</span>
                                            </div>
                                            <div className={styles.stat}>
                                                <span className={styles.statLabel}>PAYOUT</span>
                                                <span className={styles.statValue}>${pos.maxPayout}</span>
                                            </div>
                                        </div>
                                        <div className={styles.positionActions}>
                                            <button
                                                className="premium-button"
                                                style={{ width: '100%', fontSize: '0.65rem', padding: '0.75rem' }}
                                                onClick={() => setIsSubmitOpen(true)}
                                            >
                                                BOOST_QUEUE
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>
                    )}
                </div>

                <div className={styles.scrollArea}>
                    {/* Mission Control Pane */}
                    <h2 className="label-s" style={{ marginBottom: '1rem' }}>MISSION_CONTROL</h2>

                    <PointsWidget
                        userId={profile?.id || ''}
                        beliefScore={profile?.beliefScore || 0}
                        boostPoints={profile?.boostPoints || 0}
                        compact={true}
                    />

                    <TaskList
                        initialTasks={tasks}
                        onTaskComplete={handleTaskComplete}
                        compact={true}
                    />

                    <ReviewPool
                        key={refreshKey}
                        userId={profile?.id || ''}
                        onReview={handleReview}
                        onSubmit={() => setIsSubmitOpen(true)}
                    />
                </div>
            </div>

            {/* Submit Content Modal */}
            <SubmitContentModal
                isOpen={isSubmitOpen}
                userId={profile?.id || ''}
                onClose={() => setIsSubmitOpen(false)}
                onSuccess={handleSubmitSuccess}
            />

            {/* Review Modal */}
            <ReviewModal
                isOpen={isReviewOpen}
                post={selectedPost}
                validatorId={profile?.id || ''}
                onClose={() => setIsReviewOpen(false)}
                onSuccess={handleReviewSuccess}
            />
        </main>
    );
}
